user www-data;
worker_processes auto;
worker_rlimit_nofile 1000000;

events {
    worker_connections 65535;
    multi_accept on;
    use epoll;
}

http {
    include mime.types;
    default_type application/octet-stream;

    log_format cdn_log '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      '$request_time $upstream_response_time $pipe '
                      '$upstream_cache_status "$sent_http_content_range" "$http_range"';

    access_log logs/access.log cdn_log buffer=64k flush=5s;
    error_log logs/error.log warn;

    # TCP optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Timeouts
    keepalive_timeout 65;
    keepalive_requests 1000;
    client_body_timeout 15;
    client_header_timeout 15;
    send_timeout 15;

    # Buffer size optimizations
    client_max_body_size 100m;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    output_buffers 1 32k;
    postpone_output 1460;

    # Cache settings
    open_file_cache max=200000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # Compression
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;
    gzip_types
        application/javascript
        application/json
        application/x-javascript
        application/xml
        application/xml+rss
        image/svg+xml
        text/css
        text/javascript
        text/plain
        text/xml;

    # VOD caching settings
    vod_mode local;
    vod_metadata_cache metadata_cache 16m;
    vod_response_cache response_cache 512m;
    vod_last_modified_types *;
    vod_segment_duration 9000;
    vod_align_segments_to_key_frames on;
    vod_dash_fragment_file_name_prefix "segment";
    vod_hls_segment_file_name_prefix "segment";

    # File cache settings
    proxy_cache_path /var/cache/nginx/cdn_cache levels=1:2 keys_zone=cdn_cache:100m max_size=10g inactive=60m use_temp_path=off;

    server {
        listen 80;
        server_name _;

        # VOD Content location
        location /vod/ {
            root /var/www/vod;

            # VOD Module Configuration
            vod hls;
            vod_hls_segment_file_name_prefix "segment";
            vod_hls_master_file_name_prefix "master";

            # Cache Settings
            proxy_cache cdn_cache;
            proxy_cache_valid 200 302 304 1h;
            proxy_cache_lock on;
            proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;

            # Add CORS headers
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Expose-Headers "Content-Length,Content-Range";
            add_header Cache-Control "public, max-age=3600";
        }

        # Static content handling
        location /static/ {
            root /var/www;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
        }

        # VTS status for monitoring
        location /status {
            vhost_traffic_status_display;
            vhost_traffic_status_display_format html;
            allow 127.0.0.1;
            deny all;
        }
    }
}

# RTMP configuration for live streaming ingest
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record off;

            # Convert RTMP to HLS
            hls on;
            hls_path /var/www/vod/hls;
            hls_fragment 3;
            hls_playlist_length 60;
        }
    }
}